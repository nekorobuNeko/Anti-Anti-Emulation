マルウェアは基本的に仮想環境で解析されるため、マルウェアは自身が仮想環境にいると判断するとその機能を停止させるアンチエミュレーションという機能を備えている。このプログラムはマルウェアが仮想環境でない端末に侵入しても、仮想環境であると誤認させることで、マルウェアの自爆をさせることを目的としていました。WindowsにおけるマルウェアはWindows APIが使用されていることが多いため、そこに任意の処理を挿入することでそれを実現しました。
対象としたマルウェアが使用するWindows APIは
1. GetSystemInfo関数
   マルウェアはこの関数を使用し、CPUを数を基に仮想環境かどうかを判断している。
   現代のほとんどのパソコンはCPUのコア数が4つ以上のため、コアがそれ以下の時、仮想環境と判断している。
   DLLをwithdll2.exeで挿入することでCPU数が１つであるという応答を返すことができる。

2. GetFileAttributeA関数
   マルウェアはこの関数を使用し、仮想環境特有のファイルを発見したら仮想環境だと判断。
    DLLをwithdll2.exeで挿入することでファイルを探索されたら必ずそのファイルが存在すると返すようにした。
    
3. GetComputerName関数
   仮想環境では単調な名前(“USER”, ”ANDY”など)つけられることが多いので、マルウェアはGetComputerName関数でコンピューター名を探索した際、そのような名前であれば仮想環境と判断している。
   DLLをwithdll2.exeで挿入することでコンピューター名がUSERであるという応答を起こすようにする。
   
4. GetDiskFreeSpaceEx関数
   マルウェアはこの関数を使用し、ディスクサイズを基に仮想環境かどうかを判断している。
   現代のほとんどのパソコンはディスクサイズが60Gb以上のため、ディスクサイズがそれ以下の時、仮想環境と判断している。
   DLLをwithdll2.exeで挿入することでディスクサイズが60Gbであるという応答を返すことができる。
   
5. RegOpenKeyEx
   マルウェアはこの関数を使用し、仮想環境特有のレジストリを発見したら仮想環境だと判断。
    DLLをwithdll2.exeで挿入することでレジストリを探索されたら必ずそのレジストリが存在すると返すようにした。
    
6. GlobalMemoryStatusEx関数
   マルウェアはこの関数を使用し、物理メモリを基に仮想環境かどうかを判断している。
   現代のほとんどのパソコンは物理メモリが4Gb以上のため、物理メモリがそれ以下の時、仮想環境と判断している。
   DLLをwithdll2.exeで挿入することで物理メモリが4Gbであるという応答を返すことができる。
   
7. GetForegroundWindow関数
   解析に使用させる仮想環境ではアクティブウィンドウが常にデスクトップになっていることがあるため、マルウェアはこの関数を使用してアクティブウィンドウを探索し、アクティブウィンドウが常にデスクトップであるとき仮想環境と判断している。
   DLLをwithdll2.exeで挿入することで、アクティブウィンドウが常にデスクトップであるという応答を返すことができる。

コマンド例:
withdll2.exe /d:挿入するDLL 挿入されるファイル

実行例1:
GetDiskFreeSpaceEx関数を普通に使用した時、パソコンのディスクサイズを取得する。
![getdisk1](https://user-images.githubusercontent.com/78842084/119761874-95824f00-bee7-11eb-9cdb-d8de397d3be5.JPG)

ここにDLLを挿入することで、返り値を変更し、ディスクサイズが60Gbであると表示させることができる
![getdisk3](https://user-images.githubusercontent.com/78842084/119761775-67047400-bee7-11eb-9083-d5c211fdde49.JPG)

実行例2:
GetSystemInfo関数を普通に使用した時、パソコンのCPUのコアの数を取得する。
![getsys1](https://user-images.githubusercontent.com/78842084/119762331-720bd400-bee8-11eb-9f0c-7dbb0472d729.jpg)

ここにDLLを挿入することで、返り値を変更し、CPUのコアの数が1つであると表示させることができる
![getsys3](https://user-images.githubusercontent.com/78842084/119762392-94055680-bee8-11eb-8922-c80f2df78e2e.png)
